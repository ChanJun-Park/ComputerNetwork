# Ch03 Transport Layer

이 장의 목표 : 트랜스포트 계층에서 제공하는 서비스들에 대한 원리와 이 원리가 어떻게 구현되어 있는지를 안다.

## 3.1 트랜스포트 계층 서비스 및 개요

![1](image/1.png)

트랜스포트 계층의 서비스는 한마디로 양쪽의 네트워크 호스트에서 실행되는 **프로세스** 간의 **논리적 통신(Logical Communication)** 을 제공하는 것이다. 애플리케이션은 메시지를 전송하기 위해서 사용되는 물리적인 하위 구조에 상관없이 트랜스포트 계층을 사용하여 논리적인 통신을 할 수 있다.

트랜스포트 계층은 네트워크 코어가 아니라 호스트 시스템 상에서 구현된다. 트랜스포트 계층에서는 애플리케이션 계층의 프로세스에게서 다른 end system에 존재하는 프로세스로 보낼 데이터(message)를 전달받는다. 그 다음 이 message를 적당이 나눈뒤 트랜스포트 계층 헤더를 추가한다. 이 트랜스포트 계층에서의 데이터 패킷을 **세그먼트(segment)** 라고 한다. 그 다음 아래 계층인 네트워크 계층 서비스를 이용하여 수신자의 end system의 네트워크 계층으로 세그먼트를 보낸다. 수신자 호스트에 존재하는 트랜스포트 계층은 네트워크 계층으로부터 송신자가 보낸 세그먼트를 받은 뒤 이를 다시 위 계층에 존재하는 프로세스로 전달하는 역할을 한다.

애플리케이션은 트랜스포트 계층의 서비스를 이용하기 위해서 2가지 이상의 프로토콜을 사용할 수 있는데, `TCP`와 `UDP`가 대표적인 프로토콜이다.

### 3.1.1 트랜스포트 계층과 네트워크 계층 사이의 관계

트랜스포트 계층을 다루는 chapter에서 네트워크 계층을 언급하는 이유는 무엇일까? 그것은 트랜스포트 계층이 직접적으로 사용하는 서비스가 바로 아래 계층인 네트워크 계층의 서비스이기 때문이다.

트랜스포트 계층이 통신하는 두 호스트 상에서 동작하는 **프로세스들 간의 논리적 통신** 을 제공한다면, 네트워크 계층은 **호스트 간의 논리적 통신** 을 제공한다. 다음과 같은 비유로 이해해볼 수 있다.

![2](image/2.png)

위에서 서술했다시피 트랜스포트 계층은 바로 아래 네트워크 계층 서비스를 이용하여 데이터를 전송한다. 그렇기 때문에 트랜스포트 계층의 서비스는 네트워크 계층 서비스에 의존적일 수 밖에 없다. 그러나 모든 부분에서 의존적인 것은 아니다. 네트워크 계층에서 제공하지 않는 서비스를 트랜스포트 계층에서 더욱 강화하여 제공하는 경우도 있다. 예를 들어 TCP는 신뢰적 데이터 전송을 보장하는데, 네트워크 서비스는 데이터의 신뢰적 전송을 보장하지 않는다. 트랜스포트 계층에서 기능을 추가하여 서비스를 강화한 형태이다.

### 3.1.2 인터넷 트랜스포트 계층의 개요

인터넷 트랜스포트 계층에서 제공하는 프로토콜은 **TCP**와 **UDP**가 있다.

네트워크 계층에서의 프로토콜을 잠깐만 살펴보자. 이 계층에 존재하는 프로토콜은 IP(Internet Protocol)이다. 트랜스포트 계층으로부터 받은 세그먼트에 네트워크 계층 헤더를 붙여서 캡슐화한다. 이 계층에서 사용하는 데이터패킷 용어를 **데이터그램(datagram)** 이라고 한다. 네트워크 상에서 존재하는 라우터들은 네트워크 계층에서 붙인 헤더에만 접근할 수 있고, 또 그것에만 영향을 받는다. IP 프로토콜은 호스트들 간의 논리적 통신을 제공하는 **최선형 전달 서비스(best-effort delivery service)**이다. IP 프로토콜은 데이터그램이 라우터들을 지나 수신자 호스트로 전달되게 하는 비신뢰적인 서비스이다. 데이터그램이 손실되지 않는지, 순서대로 전달되는지, 데이터그램의 무결성이 깨지지는 않았는지 보장하지 않는다.

이제 TCP와 UDP에 대해서 간략하게 살펴보자. 이들 프로토콜은 네트워크 계층에서 제공하는 **호스트와 호스트간의 통신**을 **프로세스와 프로세스간의 통신** 으로 확장한다. 이것을 트랜스포트 **Multiplexing** 과 **Demultiplexing** 이라고 한다. 또한 애플리케이션 메시지를 분할하고 트랜스포트 헤더를 붙일때 오류 검출 필드를 붙여 데이터 전송의 **무결성 확인** 기능을 제공하기도 한다. 위에서 언급한 2가지 기능이 UDP에서 제공하는 기능의 전부이다. UDP는 프로세스들 간의 비신뢰적이고 비연결적인 데이터 전송을 제공한다.

반면에 TCP는 데이터 전송간에 **혼잡제어**와 **흐름제어**와 같은 추가적인 기능을 제공한다. 또한 TCP는 프로세스들 간의 **신뢰적 데이터 전송기능**을 제공한다.

## 3.2 다중화와 역다중화(Multiplexing과 Demultiplexing)

![3](image/3.png)

호스트 시스템에서는 여러 개의 네트워크 프로세스가 실행될 수 있다. 각 프로세스는 네트워크 상에 연결된 다른 호스트의 프로세스와 통신하며 메시지를 주고 받는다. 목적지 호스트의 트랜스포트 계층은 네트워크 계층으로부터 받은 데이터그램을 세그먼트로 풀고, 해당 메시지를 적절한 프로세스로 전달한다. 그렇다면 트랜스포트 계층은 여러 프로세스 중 어떻게 적절한 프로세스에게 메시지를 전달하는 것일까? 반대로 한 호스트에서 동작하는 여러 프로세스에서 생성한 메시지를 어떻게 모두 다 다른 목적지로 보낼 수 있을까?

앞에서 언급한 질문 중 첫번째를 Demultiplexing, 두번째를 Multiplexing이라고 한다. 앞서 애플리케이션 계층에서 실행되는 모든 네트워크 애플리케이션에는 포트번호가 부여된다는 것을 배웠다. 사실 포트번호는 프로세스에 부여되는 것이 아니라, 이들 프로세스가 네트워크 서비스를 이용하기 위해서 생성은 소켓에 부여되는 번호이다. 호스트에서 실행되는 네트워크 프로세스가 여러 개일 수 있는 만큼, 생성되는 소켓도 여러개가 될 수 있다. 적절하게 Demultiplexing 하기 위해서는 소켓을 식별할 수 있는 유일한 식별자가 필요해진다. 트랜스포트 계층의 프로토콜(TCP, UDP)마다 소켓을 구별하기 위한 식별자를 소켓에 부여한다.

![4](image/4.png)

트랜스포트 계층에서는 메세지에 적절한 헤더 정보를 추가하는데, 목적지 프로세스 소켓의 포트번호와 출발지 프로세스 소켓의 포트번호를 추가한다. 네트워크 계층에서는 이에 추가하여 출발지와 목적지 IP 주소 정보를 헤더에 추가하여 데이터그램을 완성시킨다. 이렇게 하여 여러 프로세스로부터 받은 메세지들을 모두 적절한 목적지로 이동할 수 있도록 Multiplexing 할 수 있다.

네트워크 계층을 통해서 목적지 호스트의 네트워크로 데이터그램을 이동시키면, 목적지 호스트의 네트워크 계층은 다시 트랜스포트 계층으로 패킷을 전송한다. 트랜스포트 계층에서는 세그먼트의 헤더정보에 담긴 목적지 포트번호를 확인하여 적절한 프로세스의 소켓에 메세지를 전달한다. 이 과정이 Demultiplexing의 원리이다. 지금 서술한 Demultiplexing은 목적지 포트번호만을 확인하는 UDP 프로토콜의 과정이다. TCP 프로토콜에서는 목적지 소켓을 특정하기 위해 추가적인 정보(출발지 포트번호, 목적지 포트번호, 출발지 IP, 목적지 IP)를 확인한다.

### 비연결형 다중화와 역다중화

![5](image/5.png)

비연결형 트랜스포트 프로토콜에서는 Multiplexing과 Demultiplexing 을 위해서 세그먼트 헤더에 출발지 포트번호와 목적지 포트번호를 설정하고 확인한다. 수신자 호스트에서 세그먼트를 수신한 트랜스포트 계층은 목적지 포트번호를 보고 적절한 프로세스의 소켓에 메시지를 전달한다. 출발지 포트번호는 메시지 수신자가 다시 송신자에게 응답메시지를 보내고 싶을 경우, 출발지 포트번호를 목적지 포트번호로 설정하여 사용하기 위해서 추가된다.

그림에서 양쪽 두개의 호스트에서 가운데 호스트로 동일한 목적지 포트 번호를 설정하여 세그먼트를 전달하는 것을 볼 수 있다. 비연결형에서는 소켓을 구별하는 식별자로 목적지 포트번호만을 사용하기 때문에 이들 데이터는 모두 동일한 프로세스의 소켓으로 전달된다.

### 연결형 다중화와 역다중화

![6](image/6.png)

TCP 연결형 다중화는 좀 더 추가적인 정보를 살펴봐야한다. 프로세스가 소유하는 소켓은 다음의 4개의 튜플로 식별된다.

- 출발지 IP와 출발지 포트번호
- 목적지 IP와 목적지 포트번호

TCP 프로토콜을 사용하는 프로세스는 여러개의 연결을 수행하여 많은 소켓을 생성하여 사용할 수 있다. 트랜스포트 계층에서 Demultiplexing을 수행하기 위해서는 세그먼트 헤더에 포함된 4가지 튜플을 확인하여 적절한 프로세스 소켓에 메시지를 전달한다(초기 서버 연결 요청은 제외). 위 그림에서 B라는 IP주소를 갖는 호스트에 3개의 세그먼트가 모두 동일한 목적지 포트번호를 갖고 전송되고 있으나, 모두 다른 소켓으로 메시지가 전송되는 것을 볼 수 있다. 이는 TCP 연결에서는 소켓을 식별하기 위해 목적지 포트 번호에 더하여 추가적인 3가지 정보(목적지 IP, 출발지 IP, 출발지 포트번호)를 사용하기 때문이다.

## 3.3 비연결형 트랜스포트: UDP
